<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">


	<meta http-equiv="content-type" content="text/html; charset=utf-8">
     <!-- <link rel="stylesheet" href="lab_3.scss"/> -->
     <!--BOOTSRAP-->
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     
     <!--LEAFLET.CSS-->
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
     integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
     crossorigin=""/>
     <!--<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />-->
     
     <!--LEAFLET.JS-->
     <script
        src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""
    ></script>

    <script src = 'https://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.js' ></script>
    <link href = 'https://labs.easyblog.it/maps/leaflet-search/src/leaflet-search.css' rel='stylesheet'/>
    <script src="leaflet.geometryutil.js"></script>
    <script src="leaflet-providers.js"></script>

    <!-- TURF -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- JQUERY -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
	<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    
    <!-- MAPBOX -->
    <script src = 'https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href = 'https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
    rel ='stylesheet'/>

    <link
    rel="shortcut icon"
    type="image/x-icon"
    href="docs/images/favicon.icon"
    /> 

    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""
     />

     <!--STYLE-->
     <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7eceb;
            width: 100vw;
            height: auto;
            display: flex;
            align-items: center;
            flex-flow: column;
            font-family: 'Roboto', sans-serif;
        }
 /* * {
    box-sizing: border-box;
  }*/
        h1 {
            font-size: 102px;
            line-height: 1;
            font-weight: 900;
            color: #00ca85;
            margin: 25px 0 0;
        }
        h1 span {
            color: #171717;
            font-weight: 300;
        }
        h3 {
            color: #f3f3f3;
            font-size: 68px;
            font-weight: 300;
            line-height: 1;
            margin: 0 0 25px;
        }
        h3 span {
            font-weight: 900;
        }
        h5 {
            color: #f3f3f3;
            font-size: 32px;
            margin: 15px;
            text-transform: uppercase;
        }
        main {
            width: 100vw;
            display: flex;
            justify-content: space-around;
        }
        main section {
            width: 100%;
            max-width: 832 px;
            height: 100vh;
            max-height: 100%;
            background: #f7eceb;
        }
        #grid { /*this is a parent DIV with the ID of grid*/
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap; 
            /*once each box makes it 100% the next one goes to the next line*/ 
            /*sometimes you don't want to wrap right away*/
        }
        #grid .box { /*the .box is the children DIVs*/
            display: flex;
            flex-basis: 100%; /*this goes off the parent grid adnd the child will have a flex basis */
            justify-content: center;
            align-items: center;
            color: #171717;
        }

        #grid .box:not(:first-of-type):not(:last-of-type) {
            height: 80vh; /*targets the middle three becuase it's targeting NOT the first one and NOT the last one*/
            flex-grow: 1; /*flex grow of 1 helps it stay responsive*/
        }


        #grid .box:first-of-type, #grid .box:last-of-type {
            height: 10vh; /*takes percentage of the screen width and not the parent DIV*/ 
            /*you don't have to take the width of the DIV*/
            flex-grow: 1; /*flex grow of 1 helps it stay responsive*/
        }

        #grid .box:nth-of-type(1) {
            /* grid-column: 1/2; */
            background: #00ca85;
            resize: horizontal;
        }

        #grid .box:nth-of-type(2) {
            background: #0085ca;
            flex-basis: 10%; /*how much width it takes up within the parent. Every child added together has to equal to 100%*/
            flex-grow: 1;
        }

        #grid .box:nth-of-type(3) {
            background: #ffce00;
            flex-basis: 60%;
            height: 70vh;
        }
        #grid .box:nth-of-type(4) {
            align-items: top;
            justify-content: top;
            background: #0085ca;
            flex-basis: 10%;
        } 

        #grid .box:nth-of-type(5) {
            justify-content: space-around;
            background: #00ca85;
        }

        #grid-for-map .box-for-map { /*the .box-for-map is the children DIVs*/
            display: flex;
            flex-basis: 100%; /*this goes off the parent grid adnd the child will have a flex basis */
            justify-content: center;
            align-items: center;
            color: #171717;
            /*height: 100%;*/
        }

        #grid-for-map .box-for-map:nth-of-type(1) {
            justify-content: space-around;
            flex-basis: 100%;
            height: 5%;
        }

        #grid-for-map .box-for-map:nth-of-type(2) {
            justify-content: space-around;
            flex-basis: 100%;
            height: 95%
        }

        #map{
            height: 100%;
            width: 100%;
        }

        #map_2{
            height: 100%;
            width: 100%;
        }

        #map_3{
            height: 100%;
            width: 100%;
        }

        #mapid{
            z-index: -1;
        }

        /* .legend {
            line-height: 18px;
            color: #555;
        } */

        .info {
            padding: 16px 28px;
            font: 14px/22px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: rgb(14, 14, 14);
        }


        .legend i {
            width: 15px;
            height: 18px;
            float: left;
            margin: 0 4px 0 0;
            opacity: 0.8;
        }

        .legend {
            padding: 2px 2px;
            font: 10px Arial, Helvetica, sans-serif;
            float: relative;
            background: white;
            background: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            /*border-radius: 5px;*/
            line-height: 24px;
            /* color: #555; */
            color: rgb(12, 12, 12);
        }
        .legend h4 {
            text-align: center;
            font-size: 12px;
            /*margin: 2px 12px 8px;*/
            color: rgb(17, 17, 17);
            margin-top: 0px;
        }
        .legend span {
            position: relative;
            bottom: 3px;
            font-size: 12px;
        }

        .w3-modal-content {
            z-index: 100;
        }
        
        .leaflet-fade-anim .leaflet-tile, .leaflet-zoom-anim .leaflet-zoom-animated { 
        will-change:auto !important; 
        }

        .leaflet-tooltip {font-size: 10px;}

        ul {
            font-size: 15px;
            color: #ffffff;
        }

        h5 {
            font-size: 20px;
        }

        h3 {
            font-size: 25px;
        }

        h3 {
            color: #ffffff;
        }

        /* hellow */

        #flex {
            display: flex; 
            justify-content: space-between;
            padding: 8px;
        }
        #flex .col {
            display: flex;
            flex-flow: column;
        }
        #flex .col.two {
            flex: 2;
        }
        #flex .col.one {
            flex: 1;
        } 

        .buttons {
            display: flex;
            font-size: 6px;
            height: 100%;
        }
  
     </style>

<title>Final Project</title>
<meta name="description" content="An interactive way to explore the EV industry in the US">
<script>
    //EVENT FUNCTIONS
    $(document).ready(function(){
        $('#map_2').hide(),
        $('#map_3').hide();
       
        $('.map-button').click(function() {
            $('#map_2').hide();
            $('#map_3').hide();
            $('#map').show();
            }),
        $('.map-button-2').click(function(){
            $('#map').hide();
            $('#map_3').hide();
            $('#map_2').show()
        }),
        $('.map-button-3').click(function(){
            $('#map').hide();
            $('#map_2').hide();
            $('#map_3').show();
            })
         
     });
</script>

<body>
    <main>
    <section id ="grid">

        <div class="box">
            <div class = "box-content">
                <h2>WELCOME TO THE ELECTRIC VEHICLE DASHBOARD</h2>
            </div>
        </div>

        <div class="box">
            <div class = "box-content">
                <h3>MAP SUMMARY</h3>
                <br>
                <br>
                <h5>Map 1: EVs Per Million Population</h5>
                <ul>Map 1 is an indication of <b>EV Consumer market maturaty</b> at the state level</ul>
                <br>
                <h5>Map 2: Num. Public Charging Outlets Per 100 EVs and % Change in Num. Public Charging Outlets Per 100 EVs</h5>
                <ul>Map 2 is an indication of <b>EV Supply Equipment (EVSE) infrastructure development</b> and how it's improved or changed over the course of two months at the state level</ul>
                <br>
                <h5>Map 3: Local Level EV Statistics and Demographics at the ZIP Code Level</h5>
                <ul>Map 3 dives into the <b>deployment of EVSE</b> relative to concentrations of different races/ethnicities</ul>
            </div>
        </div>

        <div class="box">                
            <section id = "grid-for-map">
                <div class="box-for-map">
                    <div class = "box-for-map-content">
                        <div class="btn-group">
                            <span>
                                <button type="button" class ="map-button w3-button w3-black"><b>EVs Per Million Population</b></button>
                                <button type="button" class ="map-button-2 w3-button w3-cyan"><b>Number of and % Change in Outlets Per 100 EVs</b></button>
                                <button type="button" class ="map-button-3 w3-button w3-red"><b>NYC EV Stats</b></button>
                            </span>
                        </div>
                    </div>        
                </div>
                <div class="box-for-map">
                    <div class = "box-for-map-content" id="map">
                        <div id="map" style="width: 100%; height: 100%; position: relative;" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab
                        leaflet-touch-drag leaflet-touch-zoom" tabindex="0">
                        <div class = "legend leaflet-control leaflet-bottom leaflet-left">
                            <h4>NUMBER OF EVS PER MILLION POPULATION</h4>
                            <i style="background: #fff"></i> <!--  color for <750 (class 1)-->
                            <span>Less than 750</span>
                            <br>
                            <i style="background: #eff"></i> <!--  color for 750 to 999 (class 2) -->
                            <span>750 to 999</span>
                            <br>
                            <i style="background: #cef"></i> <!--  color for 1,000 to 1,099 (class 3) -->
                            <span>1,000 to 1,099</span>
                            <br>
                            <i style="background: #bde"></i> <!--  color for 1,100 to 1,299 (class 4) -->
                            <span>1,100 to 1,299</span>
                            <br>
                            <i style="background: #7bd"></i> <!--  color for 1,300 to 1,799 (class 5) -->
                            <span>1,300 to 1,799</span>
                            <br>
                            <i style="background: #49c"></i> <!--  color for 1,800 to 2,199 (class 6) -->
                            <span>1,800 to 2,199</span>
                            <br>
                            <i style="background: #27d"></i> <!--  color for 2,200 to 3,199 (class 7) -->
                            <span>2,200 to 3,199</span>
                            <br>
                            <i style="background: #15a"></i> <!--  color for 3,200 to 3,899 (class 8) -->
                            <span>3,200 to 3,899</span>
                            <br>
                            <i style="background: #137"></i> <!--  color for 3,900 to 10,839 (class 9) -->
                            <span>3,900 to 10,839</span>
                        </div>
                        </div> 
                    </div>
                </div>
                <!--this is the SECOND DIV that will be hidden unless button is clicked-->
                <div class="box-for-map">
                    <div class = "box-for-map-content" id="map_2"> 
                        <div id="map_2" style="width: 100%; height: 100%; position: relative;" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab
                        leaflet-touch-drag leaflet-touch-zoom" tabindex="0">
                        <div class = "legend leaflet-control leaflet-bottom leaflet-left">
                            <h4>NUMBER OF CHARGING OUTLETS PER 100 EVS</h4>
                            <i style="background: #ccc"></i> <!--  color for <750 (class 1)-->
                            <span>N/A: Less than 1,000 Total Registered EVs</span>
                            <br>
                            <i style="background: #fff"></i> <!--  color for less than 10 outlets(class 1)-->
                            <span>Less than 10</span>
                            <br>
                            <i style="background: #eff"></i> <!--  color for 750 to 999 (class 2) -->
                            <span>10 to 12.99</span>
                            <br>
                            <i style="background: #cef"></i> <!--  color for 1,000 to 1,099 (class 3) -->
                            <span>13 to 14.99</span>
                            <br>
                            <i style="background: #bde"></i> <!--  color for 1,100 to 1,299 (class 4) -->
                            <span>15 to 15.99</span>
                            <br>
                            <i style="background: #7bd"></i> <!--  color for 1,300 to 1,799 (class 5) -->
                            <span>16 to 17.79</span>
                            <br>
                            <i style="background: #49c"></i> <!--  color for 1,800 to 2,199 (class 6) -->
                            <span>17.9 to 20.99</span>
                            <br>
                            <i style="background: #27d"></i> <!--  color for 2,200 to 3,199 (class 7) -->
                            <span>21 to 29.99</span>
                            <br>
                            <i style="background: #15a"></i> <!--  color for 3,200 to 3,899 (class 8) -->
                            <span>30.0 to 37.99</span>
                            <br>
                            <i style="background: #137"></i> <!--  color for 3,900 to 10,839 (class 9) -->
                            <span>38 to 40</span>
                        </div>
                        <div class = "legend leaflet-control leaflet-bottom leaflet-right">
                            <h4>% CHANGE IN NUM CHARING OUTLETS PER 100 EVS</h4>
                            <i style="background: #f77"></i> 
                            <span>DECREASE in Num Charging Outlets Per 100 EVs</span> 
                            <br>
                            <i style="background: #eff"></i> 
                            <span>0.0% to 0.69%</span>
                            <br>
                            <i style="background: #cef"></i> 
                            <span>0.70% to 1.02%</span>
                            <br>
                            <i style="background: #ade"></i> 
                            <span>1.03% to 1.99%</span>
                            <br>
                            <i style="background: #7bd"></i>
                            <span>2.0% to 2.79%</span>
                            <br>
                            <i style="background: #49c"></i> 
                            <span>2.8% to 3.99%</span>
                            <br>
                            <i style="background: #27b"></i> 
                            <span>4.0% to 4.99%</span>
                            <br>
                            <i style="background: #15a"></i> 
                            <span>5.0% to 7.99%</span>
                            <br>
                            <i style="background: #137"></i>
                            <span>8.0% to 13.0%</span>
                        </div>
                        </div> 
                    </div>
                </div>
                <!--this is the THIRD DIV that will be hidden unless button is clicked-->
                <div class="box-for-map">
                    <div class = "box-for-map-content" id="map_3"> 
                        <div id="map_3" style="width: 100%; height: 100%; position: relative;" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab
                        leaflet-touch-drag leaflet-touch-zoom" tabindex="0">
                        <div class = "legend leaflet-control leaflet-bottom leaflet-left">
                            <h4>ZIP CODE BLUE AND GREEN OUTLINES</h4>
                            <i style="background: #194D33"></i> 
                            <span>IF NO L2 OR DCFC OUTLETS AVAIL</span>
                            <br>
                            <i style="background: #0B29FB"></i>
                            <span>IF FIVE OR LESS L2 OR DCFC OUTLETS AVAIL</span>
                            <br>
                        </div>
                        </div> 
                    </div>
                </div>                                                                   
            </section>        
        </div>
        </div>    
        <div class="box">
            <div class = "box-content">
                <table class ='w3-table w3-round-large w3-border'>
                    <thead>
                        <tr class="w3-teal">
                            <strong>STATE LEVEL DATA</strong>
                        </br>
                            <select id ="state_1" onchange="changeState()">
                                <option value>Select a State</option>
                                <option value "AL">Alabama</option> <!--1-->
                                <option value "AL">Alaska</option> <!--2-->
                                <option value "AZ">Arizona</option><!--3-->
                                <option value "AR">Arkansas</option>  <!--4-->
                                <option value "CA">California</option>  <!--5-->
                                <option value "CO">Colorado</option>  <!--6-->
                                <option value "CT">Connecticut</option>  <!--7-->
                                <option value "DE">Delaware</option>  <!--8-->
                                <option value "DC">District of Columbia</option>  <!--9-->
                                <option value "FL">Florida</option>  <!--10-->
                                <option value "GA">Georgia</option>  <!--11-->
                                <option value "HI">Hawaii</option>  <!--12-->
                                <option value "ID">Idaho</option>  <!--13-->
                                <option value "IL">Illinois</option>  <!--14-->
                                <option value "IN">Indiana</option>  <!--15-->
                                <option value "IA">Iowa</option>  <!--16-->
                                <option value "KS">Kansas</option>  <!--17-->
                                <option value "KY">Kentucky</option> <!--18-->
                                <option value "LA">Louisiana</option>  <!--19-->
                                <option value "ME">Maine</option>  <!--20-->
                                <option value "MD">Maryland</option>  <!--21-->
                                <option value "MA">Massachussets</option>  <!--22-->
                                <option value "MI">Michigan</option>  <!--23-->
                                <option value "MN">Minnesota</option> <!--24-->
                                <option value "MS">Mississippi</option> <!--25--> 
                                <option value "MO">Missouri</option> <!--26-->
                                <option value "MT">Montana</option> <!--27-->
                                <option value "NE">Nebraska</option> <!--28-->
                                <option value "NV">Nevada</option> <!--29-->
                                <option value "NH">New Hampshire</option> <!--30-->
                                <option value "NJ">New Jersey</option> <!--31-->
                                <option value "NM">New Mexico</option> <!--32-->
                                <option value "NY">New York</option> <!--33-->
                                <option value "NC">North Carolina</option> <!--34-->
                                <option value "ND">North Dakota</option> <!--35-->
                                <option value "OH">Ohio</option> <!--36-->
                                <option value "OK">Oklahoma</option> <!--37-->
                                <option value "OR">Oregon</option> <!--38-->
                                <option value "PA">Pennsylvania</option> <!--39-->
                                <option value "PR">Puerto Rico</option> <!--40-->
                                <option value "RI">Rhode Island</option> <!--41-->
                                <option value "SC">South Carolina</option> <!--42-->
                                <option value "SD">South Dakota</option> <!--43-->
                                <option value "TN">Tennessee</option> <!--44-->
                                <option value "TX">Texas</option> <!--45-->
                                <option value "UT">Utah</option> <!--46-->
                                <option value "VT">Vermont</option> <!--47-->
                                <option value "VA">Virginia</option> <!--48-->
                                <option value "WA">Washington</option> <!--49-->
                                <option value "WV">West Virginia</option> <!--50-->
                                <option value "WI">Wisconsin</option> <!--51-->
                                <option value "WY">Wyoming</option> <!--52-->

                            </select>         
                        </tr>
                    </thead>
                </table>
            </div>
        </div>      
        <div class="box">
            <div class = "box-content">
                <h5>EV STATISTICS AND DEMOGRAPHIC DATA BY STATE, COUNTY, AND ZIP COMING SOON</h5>
            </div> 
        </div>

    </section>
    </main>

    <!-- SCRIPT FOR THE FIRST MAP -->

    <script>
    var map = L.map('map').setView([39.74739, -97], 5);
    
    var baseLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 12,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/light-v9',
        tileSize: 512,
        zoomOffset: -1
    })

    var baseLayer_osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    function onEachFeatureEVs(feature, layer) {
        var popupContent = "<p><strong>State: </strong>" + feature.properties.state_1 +
            "</br><strong> EVs Per Million Population: </strong>" +  Math.round(feature.properties.evs_per_mi) +
            "</br><strong> Num EVs: </strong>" + feature.properties.count_evs +
            "</br><strong> April Ratio Outlets to 100 EVs: </strong>" + feature.properties.ap_ratio_1 +
            "</br><strong> Pct Change Ratio Outlets to 100 EVs Feb - Apr: </strong>" + Math.round(feature.properties.change_p_1)+"%" +"</p>";

        if (feature.properties && feature.properties.popupContent) {
            popupContent += feature.attributes.popupContent;
        }

        layer.bindPopup(popupContent);

        layer.on({
            mouseover: function (e) {
                e.target.setStyle({ color: "#f6ff00", weight: 3 }),
                e.target.bindTooltip(feature.properties.state_1).openTooltip()},
            mouseout: (e) => {
                EVLayer.resetStyle(e.target),
                EVLayer.closeTooltip(),
                EVLayer.closePopup()},
            click: (e) => {
                EVLayer.closeTooltip()}
        });             
        };



    var EVLayer = L.geoJSON(null, {
 
        color: '#ffffff', 
        onEachFeature: onEachFeatureEVs,
        }).addTo(map);

    
    fetch('./MASTER_us_states.geojson')
    .then((response) => {
        return response.json();
    })
    .then((data) => {


        console.log(data);
        var maxVal = -Infinity, minVal = Infinity;
        var allVals = [];

        data.features.forEach((f, i) => {
            if (f.properties.count_evs > 500) {
                maxVal = Math.max(maxVal, f.properties.evs_per_mi);
                minVal = Math.min(minVal, f.properties.evs_per_mi);
                allVals.push(f.properties.evs_per_mi);
            }
        });  
        var valRange = maxVal - minVal;
        var colIntpl = d3.scaleQuantile()
            .domain(allVals)
            .range(d3.schemeBlues[9]);

        EVLayer.options.style = (f) => {
            return {
                fillColor: colIntpl(f.properties.evs_per_mi),
                color: "#ffffff",
                weight: 1,
                fillOpacity: 1
            }
        };       
        EVLayer.myExtraData = [maxVal, minVal, valRange,
            d3.scalePow()
                .exponent(0.5)
                .domain([0, maxVal])
                .range([0, 20])];
        EVLayer.addData(data);
    });

   
    //SCRIPT FOR DROP DOWN
    changeState = () => {
        var curState = document.getElementById("state_1");
        var curStateTxt = curState.options[curState.selectedIndex].text;

        //document.getElementById("chosenState").innerHTML = curStateTxt;
        // or using jQuery
        $("#chosenState").html(curStateTxt);

        // Question: How can I get other information about this state?
      };



    var baseMaps = {
        "Mapbox": baseLayer,
        "OSM": baseLayer_osm
    };

    var overlayMaps = {
        "EV Stats by State": EVLayer,
    };

    var lC = L.control.layers(baseMaps, overlayMaps, {collapsed: true, hideSingleBase: true },).addTo(map);//.expand();

    var lcDIVElem = lC.getContainer();
    document.addEventListener("keydown", (e) => {
        if (e.key === 'l' | e.key === 'L') {
            if (lcDIVElem.style.display == "") {
                lcDIVElem.style.display = "none";
            } else {
                lcDIVElem.style.display = "";
            }
        }
    });


//SEARCH CONTROL
    /*
    https://github.com/stefanocudini/leaflet-search

    Configure the OpenStreetMap nominatim
    https://nominatim.org/release-docs/develop/api/Overview/
    https://nominatim.org/release-docs/develop/api/Search/
    */
    var osmGeocoderControl = new L.Control.Search({
        url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}&countrycodes=us',
        jsonpParam: 'json_callback',
        propertyName: 'display_name',
        propertyLoc: ['lat', 'lon'],
        marker: L.circleMarker([0, 0], { radius: 30 }),
        autoCollapse: true,
        autoType: false,
        minLength: 2,
        position: 'topleft',
        container: '',
        moveToLocation: (latlng, name, map) => {
            USstatesLayerB.eachLayer((l) => {
                if (turf.booleanPointInPolygon(turf.point([latlng.lng, latlng.lat]), l.feature)){
                    l.setStyle({ fillColor: "#555" });

                    return; // to break out the eachLayer loop. "break;" does not work here.
                } 
            }); map.setView(latlng, 8);
        }
    });
    map.addControl(osmGeocoderControl);    
    
    </script>

    <!-- SCRIPT FOR THE SECOND MAP -->
    <script>
    var map_2 = L.map('map_2').setView([39.74739, -97], 5);
    
    var baseLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 12,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox/light-v9',
        tileSize: 512,
        zoomOffset: -1
    })

    var baseLayer_osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map_2);
    
    function onEachFeatureEVs(feature, layer) {
        var popupContent = "<p><strong> State: </strong>" + feature.properties.state_1 +
            "</br> <strong>April Ratio Outlets to 100 EVs: </strong>" + feature.properties.ap_ratio_1 +
            "</br><strong> Pct Change Ratio Outlets to 100 EVs Feb - Apr: </strong>" + Math.round(feature.properties.change_p_1)+"%" +
            "</br><strong> Num EVs: </strong>" + feature.properties.count_evs +
            "</br><strong> EVs Per Million Population: </strong>" + Math.round(feature.properties.evs_per_mi) + "</p>";

        if (feature.properties && feature.properties.popupContent) {
            popupContent += feature.attributes.popupContent;
        }

        layer.bindPopup(popupContent);

        layer.on({
            mouseover: function (e) {
                e.target.setStyle({ color: "#f6ff00", weight: 3 }),
                e.target.bindTooltip(feature.properties.state_1).openTooltip()},
            mouseout: (e) => {
                EVLayer2.resetStyle(e.target),
                EVLayer2.closeTooltip(),
                EVLayer2.closePopup()},
            click: (e) => {
                EVLayer2.closeTooltip()}
        });             
    };

    var EVLayer2 = L.geoJSON(null, {
 
        color: '#ffffff', 
        onEachFeature: onEachFeatureEVs,
        }).addTo(map_2);

        
    var EVLayer_pct = L.geoJSON(null, {
        
        color: '#ffffff', 
        onEachFeature: onEachFeatureEVs_3,
     });

    // $.getJSON("./MASTER_us_states.geojson", function (data) {

    //     console.log(data);
    //     //console.log(data.features.length);
        
    //     EVLayer2.addData(data);
    // });

    fetch('./MASTER_us_states.geojson')
    .then((response) => {
        return response.json();
    })
    .then((data) => {
        console.log(data);
        var maxVal = -Infinity, minVal = Infinity;
        var allVals = [];
        var allVals_pct =[];

        var maxVal_pct = -Infinity, minVal_pct = Infinity;

        data.features.forEach((f, i) => {
            if (f.properties.ap_ratio_1 > 0) {
                maxVal = Math.max(maxVal, f.properties.ap_ratio_1);
                minVal = Math.min(minVal, f.properties.ap_ratio_1);
                allVals.push(f.properties.ap_ratio_1);

                maxVal_pct = Math.max(maxVal_pct, f.properties.change_p_1);
                minVal_pct = Math.min(minVal_pct, f.properties.change_p_1);
                allVals_pct.push(f.properties.change_p_1);
            }
        });  
        var valRange = maxVal - minVal;
        var valRange_pct = maxVal_pct - minVal_pct;

        var colIntpl = d3.scaleQuantile()
            .domain(allVals)
            .range(d3.schemeBlues[9]);

        var colIntpl_pct = d3.scaleQuantile()
            .domain(allVals_pct)
            .range(d3.schemeBlues[9]);

        function styleColor(outlets_per_100evs,count_evs){
            if (count_evs<1000){
                return "#babab8"
            }
            if (count_evs>999.99){
                return colIntpl(outlets_per_100evs)
            }
        }

        function styleColor_pct(change_p_1,count_evs){                
                if (change_p_1<0){
                    return "#f2766f"
                }
                // if (count_evs>999.99){
                return colIntpl(change_p_1)
                // }
            }
        
        data.features.forEach((f,i) =>{
            EVLayer_pct.options.style = (f) => {
                    return {
                        fillColor: styleColor_pct(f.properties.change_p_1),
                        color: "#ffffff",
                        weight: 1,
                        fillOpacity: .8
                    }
                ;
            }
            if (f.properties.count_evs > 1000) {
                EVLayer2.options.style = (f) => {
                    return {
                        fillColor: styleColor(f.properties.ap_ratio_1,f.properties.count_evs),
                        color: "#ffffff",
                        weight: 1,
                        fillOpacity: .8
                    }
                };
            }
        EVLayer2.addData(data);
        EVLayer_pct.addData(data);
        });
    });

    ///orig fetch pct

    // fetch('./MASTER_us_states_2.geojson')
    //     .then((response) => {
    //         return response.json();
    //     })
    //     .then((data) => {
    //         console.log(data);
    //         var maxVal = -Infinity, minVal = Infinity;
    //         var allVals = [];
    
    //         data.features.forEach((f, i) => {
    //             if (f.properties.ap_ratio_1 > 0) {
    //                 maxVal = Math.max(maxVal, f.properties.change_p_1);
    //                 minVal = Math.min(minVal, f.properties.change_p_1);
    //                 allVals.push(f.properties.change_p_1);
    //             }
    //         });  
    //         var valRange = maxVal - minVal;
    //         var colIntpl = d3.scaleQuantile()
    //             .domain(allVals)
    //             .range(d3.schemeBlues[9]);
    
    //         function styleColor(change_p_1,count_evs){                
    //             if (change_p_1<0){
    //                 return "#f2766f"
    //             }
    //             // if (count_evs>999.99){
    //             return colIntpl(change_p_1)
    //             // }
    //         }    
    //         data.features.forEach((f,i) =>{
    //             EVLayer_pct.options.style = (f) => {
    //                 return {
    //                     fillColor: styleColor(f.properties.change_p_1,f.properties.count_evs),
    //                     color: "#ffffff",
    //                     weight: 1,
    //                     fillOpacity: .8
    //             };
    //             }
    //             EVLayer_pct.addData(data);
    //     });
    //     });


    //end orig fetchn pct

    function onEachFeatureEVs_3(feature, layer) {
            var popupContent = "<p><strong> State: </strong>" + feature.properties.state_1 +
                "</br><strong> Pct Change Ratio Outlets to 100 EVs Feb - Apr: </strong>" + Math.round(feature.properties.change_p_1).toFixed(2)+"%" +
                "</br> <strong>Num Change in Ratio of Outlets to 100 EVs Feb - Apr: </strong>" + feature.properties.change_out +                
                "</br><strong> Num EVs: </strong>" + feature.properties.count_evs +
                "</br><strong> EVs Per Million Population: </strong>" + Math.round(feature.properties.evs_per_mi) + "</p>";
    
            if (feature.properties && feature.properties.popupContent) {
                popupContent += feature.attributes.popupContent;
            }
    
            layer.bindPopup(popupContent);
    
            layer.on({
                mouseover: function (e) {
                    e.target.setStyle({ color: "#f6ff00", weight: 3 }),
                    e.target.bindTooltip(feature.properties.state_1).openTooltip()},
                mouseout: (e) => {
                    EVLayer_pct.resetStyle(e.target),
                    EVLayer_pct.closeTooltip(),
                    EVLayer_pct.closePopup()},
                click: (e) => {
                    EVLayer_pct.closeTooltip()}
            });             
            };
    
    

    var baseMaps = {
        "Mapbox": baseLayer,
        "OSM": baseLayer_osm
    };

    var overlayMaps = {
        "Num Outlets Per 100 EVs, by State": EVLayer2,
        "% Change in Num Outlets Per 100 EVs, by State":EVLayer_pct
    };

    var lC = L.control.layers(baseMaps, overlayMaps, {collapsed: true, hideSingleBase: true },).addTo(map_2);//.expand();

    var lcDIVElem = lC.getContainer();
    document.addEventListener("keydown", (e) => {
        if (e.key === 'l' | e.key === 'L') {
            if (lcDIVElem.style.display == "") {
                lcDIVElem.style.display = "none";
            } else {
                lcDIVElem.style.display = "";
            }
        }
    });
//SEARCH CONTROL
    /*
    https://github.com/stefanocudini/leaflet-search

    Configure the OpenStreetMap nominatim
    https://nominatim.org/release-docs/develop/api/Overview/
    https://nominatim.org/release-docs/develop/api/Search/
    */
    var osmGeocoderControl = new L.Control.Search({
        url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}&countrycodes=us',
        jsonpParam: 'json_callback',
        propertyName: 'display_name',
        propertyLoc: ['lat', 'lon'],
        marker: L.circleMarker([0, 0], { radius: 30 }),
        autoCollapse: true,
        autoType: false,
        minLength: 2,
        position: 'topleft',
        container: '',
        moveToLocation: (latlng, name, map_2) => {
            USstatesLayerB.eachLayer((l) => {
                if (turf.booleanPointInPolygon(turf.point([latlng.lng, latlng.lat]), l.feature)){
                    l.setStyle({ fillColor: "#555" });

                    return; // to break out the eachLayer loop. "break;" does not work here.
                } 
            }); map_2.setView(latlng, 8);
        }
    });
    map_2.addControl(osmGeocoderControl);    
    
    </script>

        <!-- SCRIPT FOR THE NYC (THIRD) MAP -->
        <script>
            var map_3 = L.map('map_3').setView([40.704913999200144, -73.96449478327085], 11);
            
            var baseLayer = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                maxZoom: 12,
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                    '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox/light-v9',
                tileSize: 512,
                zoomOffset: -1
            })
        
            var baseLayer_osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map_3);
            
            function onEachFeatureEVs_ZIPs_outlets(feature, layer) {
                var popupContent = "<p><strong> ZIP: </strong>" + feature.properties.ZIP_CODE +
                    "</br><strong> Num of L2 and DCFC Outlets: </strong>" + Math.round(feature.properties.num_l2_dcf) +
                    "</br><strong>Num Charging Stations: </strong>" + feature.properties.station_co +
                    "</br> <strong>2020 Total Pop: </strong>" + feature.properties.Total_Pop +  
                    "</br> <strong>2020 Pop Density: </strong>" + Math.round(feature.properties.Dens_Tot_P) +
                    "</br><strong> % Pop Asian: </strong>" + Math.round(feature.properties.Pct_Pop_As) +
                    "</br><strong> % Pop Black: </strong>" + Math.round(feature.properties.Pct_Pop_Bl) +
                    "</br><strong> % Pop Hispanic: </strong>" + Math.round(feature.properties.pct_hisp) +
                    "</br><strong> % Pop White: </strong>" + Math.round(feature.properties.Pct_Pop_Wh) + "</p>";
        
                if (feature.properties && feature.properties.popupContent) {
                    popupContent += feature.attributes.popupContent;
                }
        
                layer.bindPopup(popupContent);
        
                layer.on({
                    mouseover: function (e) {
                        e.target.setStyle({ color: "#f6ff00", weight: 3 }),
                        e.target.bindTooltip(feature.properties.ZIP_CODE).openTooltip()},
                    mouseout: (e) => {
                        ZIPs_NYC_outlets.resetStyle(e.target),
                        ZIPs_NYC_outlets.closeTooltip(),
                        ZIPs_NYC_outlets.closePopup()},
                    click: (e) => {
                        ZIPs_NYC_outlets.closeTooltip()}
                });             
                };
        
           
            function onEachFeatureEVs_ZIPs(feature, layer) {
            var popupContent = "<p><strong> ZIP: </strong>" + feature.properties.ZIP_CODE +
                "</br><strong> Num of L2 and DCFC Outlets: </strong>" + Math.round(feature.properties.num_l2_dcf) +
                "</br><strong>Num Charging Stations: </strong>" + feature.properties.station_co +
                "</br> <strong>2020 Total Pop: </strong>" + feature.properties.Total_Pop +  
                "</br> <strong>2020 Pop Density: </strong>" + Math.round(feature.properties.Dens_Tot_P) +
                "</br><strong> % Pop Asian: </strong>" + Math.round(feature.properties.Pct_Pop_As) +
                "</br><strong> % Pop Black: </strong>" + Math.round(feature.properties.Pct_Pop_Bl) +
                "</br><strong> % Pop Hispanic: </strong>" + Math.round(feature.properties.pct_hisp) +
                "</br><strong> % Pop White: </strong>" + Math.round(feature.properties.Pct_Pop_Wh) + "</p>";
    
            if (feature.properties && feature.properties.popupContent) {
                popupContent += feature.attributes.popupContent;
            }
    
            layer.bindPopup(popupContent);
    
            layer.on({
                mouseover: function (e) {
                    e.target.setStyle({ color: "#f6ff00", weight: 3 }),
                    e.target.bindTooltip(feature.properties.ZIP_CODE).openTooltip()},
                mouseout: (e) => {
                    ZIPs_NYC_white.resetStyle(e.target),
                    ZIPs_NYC_white.closeTooltip(),
                    ZIPs_NYC_white.closePopup(),
                    ZIPs_NYC_black.resetStyle(e.target),
                    ZIPs_NYC_black.closeTooltip(),
                    ZIPs_NYC_black.closePopup(),
                    ZIPs_NYC_asian.resetStyle(e.target),
                    ZIPs_NYC_asian.closeTooltip(),
                    ZIPs_NYC_asian.closePopup(),
                    ZIPs_NYC_hisp.resetStyle(e.target),
                    ZIPs_NYC_hisp.closeTooltip(),
                    ZIPs_NYC_hisp.closePopup(),
                    ZIPs_NYC_pop_den.resetStyle(e.target),
                    ZIPs_NYC_pop_den.closeTooltip(),
                    ZIPs_NYC_pop_den.closePopup()
                },
                click: (e) => {
                    ZIPs_NYC_black.closeTooltip()
                    ZIPs_NYC_asian.closeTooltip()
                    ZIPs_NYC_white.closeTooltip()
                    ZIPs_NYC_hisp.closeTooltip()
                    ZIPs_NYC_pop_den.closeTooltip()
                }
            });             
            };
        

            function onEachFeatureStations(feature, layer) {
                var popupContent = "<p>ZIP Code: "+feature.properties.zip +
                    "</br> Chargers Available: " + feature.properties.combo +
                    "</br> Total L2 + DCFC Outlets: " + feature.properties.all_l2_dcf + 
                    "</br> Num L2 Outlets: " + feature.properties.num_l2 +
                    "</br> Num DCFC Outlets: " + feature.properties.num_dcfc + "</p>";

                    if (feature.properties && feature.properties.popupContent) {
                        popupContent += feature.attributes.popupContent;
                    }

                    layer.bindPopup(popupContent);
                    
                    layer.on({
                        mouseover: function(e) {
                            e.target.setStyle({ radius: 17, color: "#9b090b",weight: 3});
                            e.target.openPopup()},
                        mouseout: (e) => {
                            stationsApr_outlets.resetStyle(e.target),
                            stationsApr_outlets.closePopup(e.target)},
                    });
            };

                //Functions to Style Outlets by Type and by Num. Outlets
            function getColor_stations_combo(d) {
                //if (d = feature.properties.combo) {
                if (d == "L1 ONLY") return '#a1faab'; //light green
                if (d == "L2 Only") return '#cfcdfb'; //light blue
                if (d == "DCFC Only") return '#4e6cff'; //med blue
                if (d == "L2 and DCFC Only") return '#001ca3'; //dark blue
                if (d == "L1 and L2 Only") return '#48b254'; //med green
                if (d == "All Chargers Only") return '#1a6b23'; //dark green
                return '#b048fb'; //purple       
            };

            function getColor_stations_outlets(d) {
                if (d < 5) return '#cfcdfb';
                if (d < 10) return '#6383fa';
                if (d < 15) return '#0035ff';
                if (d < 20) return '#001e90';
                return '#000c3c'
            };

            function getStroke_stations_outlets(d) {
                if (d > 1) return '#fc060a';
                return "#000"    
            }

            function getWeight_stations_outlets(d) {
                if (d > 1) return '3';
                return 1
            }

            function getRadius_stations_outlets(d){
                if (d<5) return 7;
                if (d<10) return 11;
                if (d<15) return 15;
                if (d<20) return 19;
                if (d<30) return 26
            }

            function get_fillColor_outlets(d){

                if (d<1) return "#bab8b8";
                //if (d<3) return "#cfc";
                //if (d<7) return "#aea";
                if (d<5) return "#7c7";
                //if (d<10) return "#7c7";
                if (d<11) return "#4b6";
                if (d<27) return "#294";
                if (d<70) return "#063";
            }

            function get_fillColor_black(d){
                if (d<=1.677517) return "#ffe";
                if (d<=3.450053) return "#fda";
                if (d<=6.469272) return "#fb7";
                if (d<=13.196201) return "#f94";
                if (d<=28.556804) return "#f71";
                if (d<=56.171296) return "#e50";
                if (d<=91.002784) return "#930";
            }
            
            function get_fillColor_asian(d){
                if (d<=2.070286) return "#ffe";
                if (d<=4.136925) return "#fda";
                if (d<=6.694210) return "#fb7";
                if (d<=12.325468) return "#f94";
                if (d<=19.455793) return "#f71";
                if (d<=32.000613) return "#e50";
                if (d<=72.221539) return "#930";
            }

            function get_fillColor_hisp(d){
                if (d<=8.81) return "#ffe";
                if (d<=12.58) return "#fda";
                if (d<=16.44) return "#fb7";
                if (d<=22.37) return "#f94";
                if (d<=30.81) return "#f71";
                if (d<=51.7) return "#e50";
                if (d<=77.79) return "#930";
            }

            function get_fillColor_pop_den(d){
                if (d<=11184.577384) return "#fff";
                if (d<=18803.709219) return "#eef";
                if (d<=29704.115637) return "#cce";
                if (d<=39317.450304) return "#aad";
                if (d<=52509.213375) return "#88c";
                if (d<=72058.617103) return "#75a";
                if (d<=508254.462900) return "#518";
            }


            function get_fillColor_white(d){
                if (d<=12.755655) return "#ffe";
                if (d<=23.253367) return "#fda";
                if (d<=34.254772) return "#fb7";
                if (d<=51.010122) return "#f94";
                if (d<=61.883658) return "#f71";
                if (d<=73.433783) return "#e50";
                if (d<=95.265098) return "#930";
            }

            //make legend variables

            var legend_outlets = L.control({position: 'bottomright', opacity: 0.8});            
            legend_outlets.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    num_l2_dcf = [0,0, 4, 10, 26],
                    labels = ["Num L2 and DCFC Outlets"],
                    from, to;

                for (var i = 0; i < num_l2_dcf.length; i++) {
                    from = num_l2_dcf[i];
                    to = num_l2_dcf[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_outlets(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };

            var legend_outlets_size = L.control({position: 'bottomright', opacity: 0.8});            
            legend_outlets_size.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    num_outlet = [0,0, 4, 10, 26],
                    labels = ["Num L2 and DCFC Outlets (Point Size)"],
                    from, to;

                    for (var i = 0; i < num_outlet.length; i++) {
                        var num_outlet = num_outlets[i]*5;
                        categories = ['> 100','50-100','1-50','N/A','XX'];
                        labels.push('<i class="circlepadding" style="width: 5px;"></i> <i  style="background: #8080A0; width: '+getRadius_stations_outlets(num_outlet)*2+'px; height: '+getRadius_stations_outlets(num_outlet)*2+'px; border-radius:  50%; margin-top: '+Math.max(0,(9-getRadius(num_outlet)))+'px;"></i> '+categories[i]);
                    }
                
                    for (var i = 0; i < num_l2_dcf.length; i++) {
                    from = num_l2_dcf[i];
                    to = num_l2_dcf[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_outlets(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

            div.innerHTML = labels.join('<br>');
            return div;
            };
            
            var legend_outlets_color = L.control({position: 'bottomright', opacity: 0.8});            
            legend_outlets_color.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    combo = ["L2 Only", "DCFC Only", "L2 and DCFC Only", "L1 Only", "L1 and L2 Only","All Chargers Only"],
                    labels = ["Num L2 and DCFC Outlets (Color)"],
                    from, to;

                for (var i = 0; i < combo.length; i++) {
                    from = combo[i];
                    to = combo[i + 1];

                    labels.push(
                        '<i style="background:' + getColor_stations_combo(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };

            var legend_pop_den = L.control({position: 'bottomright', opacity: 0.8});
            legend_pop_den.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                Dens_Tot_P = [0, 11185, 18804, 29704, 39317,
                52509, 72058],
                    labels = ["Population Density (Pop/Sq Mi)"],
                    from, to;

                for (var i = 0; i < Dens_Tot_P.length; i++) {
                    from = Dens_Tot_P[i];
                    to = Dens_Tot_P[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_pop_den(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };
            
            var legend_white = L.control({position: 'bottomright', opacity: 0.8});
            legend_white.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    pct_white = [0, 12.8, 23.3, 34.3, 51.0,
                    61.9, 73.4],
                    labels = ["% White Population"],
                    from, to;

                for (var i = 0; i < pct_white.length; i++) {
                    from = pct_white[i];
                    to = pct_white[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_white(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };
            
            var legend_black = L.control({position: 'bottomright', opacity: 0.8});
            legend_black.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    pct_black = [0, 1.7, 3.5, 6.5, 13.2,
                    28.6, 56.2],
                    labels = ["% Black Population"],
                    from, to;

                for (var i = 0; i < pct_black.length; i++) {
                    from = pct_black[i];
                    to = pct_black[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_black(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };

            var legend_asian = L.control({position: 'bottomright', opacity: 0.8});
            legend_asian.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    pct_asian = [0,2.1, 4.1, 6.7, 12.3,
                    19.5, 32.0],
                    labels = ["% Asian Population"],
                    from, to;

                for (var i = 0; i < pct_asian.length; i++) {
                    from = pct_asian[i];
                    to = pct_asian[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_asian(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };

            var legend_hisp = L.control({position: 'bottomright', opacity: 0.8});
            legend_hisp.onAdd = function (map_3) {

                var div = L.DomUtil.create('div', 'info legend'),
                    pct_hisp = [0, 1.81, 12.58, 16.44, 22.37,
                    30.81, 51.7],
                    labels = ["% Hispanic Population"],
                    from, to;

                for (var i = 0; i < pct_hisp.length; i++) {
                    from = pct_hisp[i];
                    to = pct_hisp[i + 1];

                    labels.push(
                        '<i style="background:' + get_fillColor_hisp(from + 1) + '"></i> ' +
                        from + (to ? '&ndash;' + to : '+'));
                }

                div.innerHTML = labels.join('<br>');
                return div;
            };


            var stationsApr_type = L.geoJson(null, {
                pointToLayer: function (feature, latlng) {
                    let val = getColor_stations_combo("");
                    return L.circleMarker(latlng, {
                        fillColor: getColor_stations_combo(feature.properties.combo),
                        fillOpacity: 1,
                        weight: getWeight_stations_outlets(feature.properties.num_dcfc),
                        radius: getRadius_stations_outlets(feature.properties.all_l2_dcf),
                        color: getStroke_stations_outlets(feature.properties.num_dcfc)
                    });
                },
                onEachFeature: onEachFeatureStations
            })
            
            var ZIPs_NYC_outlets = L.geoJSON(null, {
            
                color: '#ffffff', 
                onEachFeature: onEachFeatureEVs_ZIPs_outlets,
                }).addTo(map_3);
            
            var ZIPs_NYC_pop_den = L.geoJSON(null, {           
                color: '#ffffff', 
                onEachFeature: onEachFeatureEVs_ZIPs,
            })
            
            var ZIPs_NYC_asian = L.geoJSON(null, {           
                color: '#ffffff', 
                onEachFeature: onEachFeatureEVs_ZIPs,
            })
            var ZIPs_NYC_black = L.geoJSON(null, {
                color: '#ffffff', 
                onEachFeature: onEachFeatureEVs_ZIPs,
            })
            var ZIPs_NYC_hisp = L.geoJSON(null, {           
                color: '#ffffff', 
                onEachFeature: onEachFeatureEVs_ZIPs,
            })
            
            var ZIPs_NYC_white = L.geoJSON(null, {           
                color: '#ffffff', 
                onEachFeature: onEachFeatureEVs_ZIPs,
            })
            

            //ZIPS OUTLET LAYER
            $.getJSON("./zips_select_NYC_CLEAN2.geojson", function (data) {
        
                console.log(data);
                //console.log(data.features.length);
                
                ZIPs_NYC_outlets.addData(data);
            });

            fetch('./zips_select_NYC_CLEAN2.geojson')
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                console.log(data);
                var maxVal = -Infinity, minVal = Infinity;
                var allVals = [];

                data.features.forEach((f, i) => {
                    maxVal = Math.max(maxVal, f.properties.num_l2_dcf);
                    minVal = Math.min(minVal, f.properties.num_l2_dcf);
                    allVals.push(f.properties.num_l2_dcf);
                });  
                var valRange = maxVal - minVal;
                var colIntpl = d3.scaleQuantile()
                    .domain(allVals)
                    .range(d3.schemeGreens[7]);

                function styleColor(num_l2_dcf){                
                    if (num_l2_dcf==0){
                        return "#bab8b8"
                    }
                    return colIntpl(num_l2_dcf)
                }

                data.features.forEach((f,i) =>{
                    ZIPs_NYC_outlets.options.style = (f) => {
                        return {
                            fillColor: styleColor(f.properties.num_l2_dcf),
                            color: "#ffffff",
                            weight: 1,
                            fillOpacity: .8
                    };
                    }
                    ZIPs_NYC_outlets.addData(data);
                });
            });
            //END ZIPS OUTLET LAYER

            //ZIPS POP DENSITY LAYER    
            $.getJSON("./zips_select_NYC_CLEAN2.geojson", function (data) {
                console.log(data);
                //console.log(data.features.length);

                ZIPs_NYC_pop_den.addData(data);
            });

            fetch('./zips_select_NYC_CLEAN2.geojson')
            .then((response) => {
            return response.json();
            })
            .then((data) => {
                console.log(data);
                var maxVal = -Infinity, minVal = Infinity;
                var allVals = [];

                data.features.forEach((f, i) => {
                    maxVal = Math.max(maxVal, f.properties.Dens_Tot_P);
                    minVal = Math.min(minVal, f.properties.Dens_Tot_P);
                    allVals.push(f.properties.Dens_Tot_P);
                });  
                var valRange = maxVal - minVal;
                var colIntpl = d3.scaleQuantile()
                    .domain(allVals)
                    .range(d3.schemePurples[7]);

                function styleOutline(num_l2_dcf){
                    if (num_l2_dcf==0){
                        return "#194D33"
                    }
                    if (num_l2_dcf <6){
                        return "#0B29FB"
                    }
                    return "#ffffff"
                }

                function styleWeight(num_l2_dcf){
                    if (num_l2_dcf<6){
                        return 2.5
                    }
                    return 1
                }

                data.features.forEach((f,i) =>{
                    ZIPs_NYC_pop_den.options.style = (f) => {
                        return {
                            fillColor: colIntpl(f.properties.Dens_Tot_P),
                            color: styleOutline(f.properties.num_l2_dcf),
                            weight: styleWeight(f.properties.num_l2_dcf),
                            fillOpacity: .9
                    };
                    }
                    ZIPs_NYC_pop_den.addData(data);
                });
            });
            //END ZIPS POP DENSITY LAYER

            //ZIPS PCT ASIAN LAYER    
            $.getJSON("./zips_select_NYC_CLEAN2.geojson", function (data) {
                console.log(data);
                //console.log(data.features.length);

                ZIPs_NYC_asian.addData(data);
            });

            fetch('./zips_select_NYC_CLEAN2.geojson')
            .then((response) => {
            return response.json();
            })
            .then((data) => {
                console.log(data);
                var maxVal = -Infinity, minVal = Infinity;
                var allVals = [];

                data.features.forEach((f, i) => {
                    maxVal = Math.max(maxVal, f.properties.Pct_Pop_As);
                    minVal = Math.min(minVal, f.properties.Pct_Pop_As);
                    allVals.push(f.properties.Pct_Pop_As);
                });  
                var valRange = maxVal - minVal;
                var colIntpl = d3.scaleQuantile()
                    .domain(allVals)
                    .range(d3.schemeOranges[7]);

                function styleOutline(num_l2_dcf){
                    if (num_l2_dcf==0){
                        return "#194D33"
                    }
                    if (num_l2_dcf <6){
                        return "#0B29FB"
                    }
                    return "#ffffff"
                }

                function styleWeight(num_l2_dcf){
                    if (num_l2_dcf<6){
                        return 2.5
                    }
                    return 1
                }

                data.features.forEach((f,i) =>{
                    ZIPs_NYC_asian.options.style = (f) => {
                        return {
                            fillColor: colIntpl(f.properties.Pct_Pop_As),
                            color: styleOutline(f.properties.num_l2_dcf),
                            weight: styleWeight(f.properties.num_l2_dcf),
                            fillOpacity: .9
                    };
                    }
                    ZIPs_NYC_asian.addData(data);
                });
            });
            //END ZIPS PCT ASIAN LAYER

            //ZIPS PCT BLACK LAYER    
            $.getJSON("./zips_select_NYC_CLEAN2.geojson", function (data) {
                console.log(data);
                //console.log(data.features.length);

                ZIPs_NYC_black.addData(data);
            });

            fetch('./zips_select_NYC_CLEAN2.geojson')
            .then((response) => {
            return response.json();
            })
            .then((data) => {
                console.log(data);
                var maxVal = -Infinity, minVal = Infinity;
                var allVals = [];

                data.features.forEach((f, i) => {
                    maxVal = Math.max(maxVal, f.properties.Pct_Pop_Bl);
                    minVal = Math.min(minVal, f.properties.Pct_Pop_Bl);
                    allVals.push(f.properties.Pct_Pop_Bl);
                });  
                var valRange = maxVal - minVal;
                var colIntpl = d3.scaleQuantile()
                    .domain(allVals)
                    .range(d3.schemeOranges[7]);

                function styleOutline(num_l2_dcf){
                    if (num_l2_dcf==0){
                        return "#194D33"
                    }
                    if (num_l2_dcf <6){
                        return "#0B29FB"
                    }
                    return "#ffffff"
                }

                function styleWeight(num_l2_dcf){
                    if (num_l2_dcf<6){
                        return 2.5
                    }
                    return 1
                }

                data.features.forEach((f,i) =>{
                    ZIPs_NYC_black.options.style = (f) => {
                        return {
                            fillColor: colIntpl(f.properties.Pct_Pop_Bl),
                            color: styleOutline(f.properties.num_l2_dcf),
                            weight: styleWeight(f.properties.num_l2_dcf),
                            fillOpacity: .9
                    };
                    }
                    ZIPs_NYC_black.addData(data);
                });
            });
            //END ZIPS PCT BLACK LAYER

            //ZIPS PCT HISPANIC LAYER    
            $.getJSON("./zips_select_NYC_CLEAN2.geojson", function (data) {
                console.log(data);
                //console.log(data.features.length);

                ZIPs_NYC_hisp.addData(data);
            });

            fetch('./zips_select_NYC_CLEAN2.geojson')
            .then((response) => {
            return response.json();
            })
            .then((data) => {
                console.log(data);
                var maxVal = -Infinity, minVal = Infinity;
                var allVals = [];

                data.features.forEach((f, i) => {
                    maxVal = Math.max(maxVal, f.properties.pct_hisp);
                    minVal = Math.min(minVal, f.properties.pct_hisp);
                    allVals.push(f.properties.pct_hisp);
                });  
                var valRange = maxVal - minVal;
                var colIntpl = d3.scaleQuantile()
                    .domain(allVals)
                    .range(d3.schemeOranges[7]);

                function styleOutline(num_l2_dcf){
                    if (num_l2_dcf==0){
                        return "#194D33"
                    }
                    if (num_l2_dcf <6){
                        return "#0B29FB"
                    }
                    return "#ffffff"
                }

                function styleWeight(num_l2_dcf){
                    if (num_l2_dcf<6){
                        return 2.5
                    }
                    return 1
                }

                data.features.forEach((f,i) =>{
                    ZIPs_NYC_hisp.options.style = (f) => {
                        return {
                            fillColor: colIntpl(f.properties.pct_hisp),
                            color: styleOutline(f.properties.num_l2_dcf),
                            weight: styleWeight(f.properties.num_l2_dcf),
                            fillOpacity: .9
                    };
                    }
                    ZIPs_NYC_hisp.addData(data);
                });
            });
            //END ZIPS PCT HISPANIC LAYER

            //ZIPS PCT WHITE LAYER    
            $.getJSON("./zips_select_NYC_CLEAN2.geojson", function (data) {

                console.log(data);
                //console.log(data.features.length);
                
                ZIPs_NYC_white.addData(data);
            });

            fetch('./zips_select_NYC_CLEAN2.geojson')
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                console.log(data);
                var maxVal = -Infinity, minVal = Infinity;
                var allVals = [];

                data.features.forEach((f, i) => {
                    maxVal = Math.max(maxVal, f.properties.Pct_Pop_Wh);
                    minVal = Math.min(minVal, f.properties.Pct_Pop_Wh);
                    allVals.push(f.properties.Pct_Pop_Wh);
                });  
                var valRange = maxVal - minVal;
                var colIntpl = d3.scaleQuantile()
                    .domain(allVals)
                    .range(d3.schemeOranges[7]);

                function styleOutline(num_l2_dcf){
                    if (num_l2_dcf==0){
                        return "#194D33"
                    }
                    if (num_l2_dcf <6){
                        return "#0B29FB"
                    }
                    return "#ffffff"
                }

                function styleWeight(num_l2_dcf){
                    if (num_l2_dcf<6){
                        return 2.5
                    }
                    return 1
                }

                data.features.forEach((f,i) =>{
                    ZIPs_NYC_white.options.style = (f) => {
                        return {
                            fillColor: colIntpl(f.properties.Pct_Pop_Wh),
                            color: styleOutline(f.properties.num_l2_dcf),
                            weight: styleWeight(f.properties.num_l2_dcf),
                            fillOpacity: .7
                    };
                    }
                    ZIPs_NYC_white.addData(data);
                });
            });
            //END ZIPS PCT WHITE LAYER

            var stationsApr_outlets = L.geoJson(null, {
                pointToLayer: function (feature, latlng) {
                    //let val = getColor_stations_outlets("");
                    return L.circleMarker(latlng, {
                        fillColor: getColor_stations_outlets(feature.properties.all_l2_dcf),
                        fillOpacity: 1,
                        weight: getWeight_stations_outlets(feature.properties.num_dcfc),
                        radius: getRadius_stations_outlets(feature.properties.all_l2_dcf),
                        color: getStroke_stations_outlets(feature.properties.num_dcfc)
                    });
                },
                onEachFeature: onEachFeatureStations
            });

            //add data for both stations type and stations outlet
            $.getJSON("./afdc_data_nyc_04_23_2022.geojson", function (data) {
                console.log(data);
                console.log(data.features.length);

                stationsApr_type.addData(data),
                stationsApr_outlets.addData(data)
            })

            fetch('./afdc_data_nyc_04_23_2022.geojson')
            .then((response) =>{
                return response.json();
            })
            .then((data)=>{
                    console.log(data);
            });

                       
            var baseMaps = {
                "Mapbox": baseLayer,
                "OSM": baseLayer_osm
            };
        
           var overlayMaps = {
            "Num. EV Charging Outlets by ZIP": ZIPs_NYC_outlets,
            "Pop Density (Pop/Sq Mi) by ZIP": ZIPs_NYC_pop_den,
            "Percent Asian by ZIP": ZIPs_NYC_asian,
            "Percent Black by ZIP": ZIPs_NYC_black,
            "Percent Hispanic by ZIP": ZIPs_NYC_hisp,
            "Percent White by ZIP" : ZIPs_NYC_white,
            //"Num. EV Charging Outlets by ZIP": ZIPs_NYC_outlets,
           "EV Stations (Updated Apr 2022) by Type": stationsApr_type,
           }
        
           var lC = L.control.layers(baseMaps, overlayMaps, {collapsed: true, hideSingleBase: true },).addTo(map_3);//.expand();
        
            var lcDIVElem = lC.getContainer();
            document.addEventListener("keydown", (e) => {
                if (e.key === 'l' | e.key === 'L') {
                    if (lcDIVElem.style.display == "") {
                        lcDIVElem.style.display = "none";
                    } else {
                        lcDIVElem.style.display = "";
                    }
                }
            });

            legend_outlets.addTo(map_3);

        //SEARCH CONTROL
            /*
            https://github.com/stefanocudini/leaflet-search
        
            Configure the OpenStreetMap nominatim
            https://nominatim.org/release-docs/develop/api/Overview/
            https://nominatim.org/release-docs/develop/api/Search/
            */
            var osmGeocoderControl = new L.Control.Search({
                url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}&countrycodes=us',
                jsonpParam: 'json_callback',
                propertyName: 'display_name',
                propertyLoc: ['lat', 'lon'],
                marker: L.circleMarker([0, 0], { radius: 30 }),
                autoCollapse: true,
                autoType: false,
                minLength: 2,
                position: 'topleft',
                container: '',
                moveToLocation: (latlng, name, map_3) => {
                    USstatesLayerB.eachLayer((l) => {
                        if (turf.booleanPointInPolygon(turf.point([latlng.lng, latlng.lat]), l.feature)){
                            l.setStyle({ fillColor: "#555" });
        
                            return; // to break out the eachLayer loop. "break;" does not work here.
                        } 
                    }); map_3.setView(latlng, 8);
                }
            });
            map_3.addControl(osmGeocoderControl);   
            
                        //MAKE LEGEND EVENTS
                        currentLegend = legend_outlets;
            map_3.on('overlayadd', function (eventLayer) {
                if (eventLayer.name === 'Num. EV Charging Outlets by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    map_3.removeControl(currentLegend);
                    currentLegend = legend_outlets;
                    legend_outlets.addTo(map_3);
                }
                else if  (eventLayer.name === 'Percent Black by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    map_3.removeControl(currentLegend);
                    currentLegend = legend_black;
                    legend_black.addTo(map_3);
                }
                else if  (eventLayer.name === 'Percent White by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    map_3.removeControl(currentLegend);
                    currentLegend = legend_white;
                    legend_white.addTo(map_3);
                }
                else if  (eventLayer.name === 'Percent Asian by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    map_3.removeControl(currentLegend);
                    currentLegend = legend_asian;
                    legend_asian.addTo(map_3);
                }
                else if  (eventLayer.name === 'Percent Hispanic by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    map_3.removeControl(currentLegend);
                    currentLegend = legend_hisp;
                    legend_hisp.addTo(map_3);
                }
                else if  (eventLayer.name === 'Num. EV Charging Outlets by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    legend_outlets_size.addTo(map_3);
                    legend_oultets_color.addTo(map_3);
                }
                else if  (eventLayer.name === 'Pop Density (Pop/Sq Mi) by ZIP') {
                    ZIPs_NYC_outlets.bringToFront();
                    map_3.removeControl(currentLegend);
                    currentLegend = legend_pop_den;
                }
            }) 
        </script>

        <!--JS for Bootstrap. JQuery and Popper-->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>

</head>